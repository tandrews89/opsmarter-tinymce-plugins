/*global tinymce:true */
tinymce.PluginManager.add('CRRequest', function(editor) {
    document.addEventListener('gotCRData', function(e) {
        var detail = JSON.parse(e.detail);
        editor.execCommand("mceInsertContent", false, 'Hi ' + detail.detail.client_name + ',<br /><br />I have scheduled the rolling restart for the time you provided me. I have provided the details of the work to be completed below. <br />&nbsp;<table border="0" cellpadding="0" cellspacing="0" style="width:680px"><tbody><tr><td colspan="3" style="height:20px; width:680px"><strong>Instructions</strong></td></tr><tr><td colspan="3" style="height:91px; width:680px">The following information has been submitted to our Operations Team to address your request. Please confirm this information is correct by responding to the case note.&nbsp; If this information is incorrect or you wish to change the time, please update this case and call support immediately.&nbsp; Support can be reached at (888) 788-5264 (North America) or +1.202.715.6019 (International).&nbsp; Additional International toll-free numbers are listed on Behind the Blackboard.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr><tr><td colspan="3" style="height:20px"><strong>Change Request Information</strong></td></tr><tr><td style="height:20px">Subject</td><td colspan="2">' + detail.detail.subject + '</td></tr><tr><td style="height:20px">Description (Server Info)</td><td colspan="2">N/A</td></tr><tr><td style="height:20px">Production/Staging/Test/Development</td><td colspan="2">' + detail.detail.environment + '</td></tr><tr><td style="height:21px">Support Case Notes</td><td colspan="2">' + detail.detail.support_case + '</td></tr><tr><td colspan="3" style="height:20px"><strong>Scheduling Information</strong></td></tr><tr><td colspan="2" style="height:20px">Client Time Zone: ' + detail.detail.timezone + '</td><td>Blackboard : US Eastern Time</td></tr><tr><td style="height:20px">Start Date &amp; Time Requested</td><td colspan="2">' + detail.detail.start_date + '</td></tr><tr><td style="height:20px">End Date &amp; Time Requested</td><td colspan="2">' + detail.detail.end_date + '</td></tr><tr><td style="height:21px">Required Downtime&nbsp; Yes/No&nbsp;</td><td colspan="2">' + detail.detail.downtime_required + '</td></tr><tr><td colspan="3" style="height:20px"><strong>Guidelines for Submitting a Change Request</strong></td></tr><tr><td colspan="3" style="height:101px; width:680px">Minimum advance notice of a one business day is required to submit a change request via Behind the Blackboard or&nbsp; support case email.&nbsp;&nbsp; If you have an urgent request that does not allow for a full business day&rsquo;s notice, please call support&nbsp; at (888) 788-5264 (North America) or +1.202.715.6019 (International).&nbsp; Additional International toll-free numbers are listed on Behind the Blackboard.</td></tr></tbody></table><br/>'+detail.detail.signature);
    });
	
	
	editor.addButton('Messages', function(){
	return {
	type: 'listbox',
	text: 'Canned Messages',
	tooltip: 'Canned Messages',
	values: {{text: 'Hello', value: 'Hello'}};
	});

    function showDialog() {
        editor.windowManager.open({
            title: 'Generate Change Request Template',
            body: [{
                type: 'textbox',
                name: 'client_name',
                size: 20,
                label: 'Client Name:',
            }, {
                type: 'textbox',
                name: 'cr_id',
                size: 20,
                label: 'CR ID/URL:',
            }, {
                type: 'combobox',
                name: 'timezone',
                size: 20,
                label: 'Client Time Zone:',
                values: [{
                    text: "Eastern",
                    value: "EST"
                }, {
                    text: "Central",
                    value: "CST"
                }, {
                    text: "Mountain",
                    value: "MST"
                }]
            }, {
                type: 'listbox',
                name: 'environment',
                size: 20,
                label: 'Client Environment:',
                values: [{
                    text: "Production",
                    value: "Production"
                }, {
                    text: "Testing",
                    value: "Testing"
                }, {
                    text: "Staging",
                    value: "Staging"
                }, {
                    text: "Development",
                    value: "Development"
                }]
            }],
            onsubmit: function(e) {
                var cr_id = e.data.cr_id;
                var regex = /nid=CT&tkt=([0-9]+)/.exec(cr_id);
				
                if (regex !== null) {
                    var evt = new CustomEvent('getCRData', {
                        detail: {
                            'cr_id': regex[1],
                            'timezone': e.data.timezone,
                            'client_name': e.data.client_name,
                            'environment': e.data.environment
                        }
                    });
                    document.dispatchEvent(evt);
                } else {
                    alert('The provided CR URL is invalid.');
                }
            }
        });
    }
    editor.addMenuItem('CRRequest', {
        text: 'Change Request Template',
        context: 'insert',
        onclick: showDialog
    });

    editor.addButton('CRGenerate', {
        text: 'CR',
        tooltip: 'Generate CR Request',
        onclick: showDialog
    });

});